generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MEMBER
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  SENT
  VIEWED
  PAID
  VOID
}

enum ActorType {
  INTERNAL
  CUSTOMER
  SYSTEM
}

enum EventType {
  DRAFT_CREATED
  DRAFT_UPDATED
  INVOICE_ISSUED
  VIEW_TOKEN_CREATED
  DELIVERY_SENT
  INVOICE_VIEWED
  INVOICE_PAID
  PDF_GENERATED
}

enum DeliveryChannel {
  EMAIL
}

model Tenant {
  id        String     @id @default(cuid())
  name      String
  createdAt DateTime   @default(now()) @map("created_at")
  users     User[]
  customers Customer[]
  invoices  Invoice[]

  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  tenantId     String   @map("tenant_id")
  email        String
  passwordHash String   @map("password_hash")
  role         UserRole
  createdAt    DateTime @default(now()) @map("created_at")
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@map("users")
}

model Customer {
  id             String   @id @default(cuid())
  tenantId       String   @map("tenant_id")
  name           String
  email          String
  billingAddress String   @map("billing_address")
  createdAt      DateTime @default(now()) @map("created_at")
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoices       Invoice[]

  @@map("customers")
}

model Invoice {
  id               String           @id @default(cuid())
  tenantId         String           @map("tenant_id")
  customerId       String           @map("customer_id")
  invoiceNumber    String           @map("invoice_number")
  currency         String
  status           InvoiceStatus    @default(DRAFT)
  issuedAt         DateTime?        @map("issued_at")
  dueDate          DateTime         @map("due_date")
  totalAmount      Decimal          @db.Decimal(12, 2) @map("total_amount")
  currentVersionId String?          @unique @map("current_version_id")
  createdAt        DateTime         @default(now()) @map("created_at")
  tenant           Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer         Customer         @relation(fields: [customerId], references: [id], onDelete: Restrict)
  currentVersion   InvoiceVersion?  @relation("CurrentInvoiceVersion", fields: [currentVersionId], references: [id])
  versions         InvoiceVersion[] @relation("InvoiceVersions")
  deliveries       InvoiceDelivery[]
  viewTokens       InvoiceViewToken[]
  events           InvoiceEvent[]

  @@unique([tenantId, invoiceNumber])
  @@map("invoices")
}

model InvoiceVersion {
  id              String   @id @default(cuid())
  invoiceId       String   @map("invoice_id")
  versionNumber   Int      @map("version_number")
  snapshotJson    Json     @map("snapshot_json")
  subtotal        Decimal  @db.Decimal(12, 2)
  tax             Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  createdByUserId String   @map("created_by_user_id")
  invoice         Invoice  @relation("InvoiceVersions", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, versionNumber])
  @@map("invoice_versions")
}

model InvoiceDelivery {
  id                String          @id @default(cuid())
  invoiceId         String          @map("invoice_id")
  channel           DeliveryChannel
  toEmail           String          @map("to_email")
  sentAt            DateTime        @map("sent_at")
  providerMessageId String?         @map("provider_message_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  invoice           Invoice         @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_deliveries")
}

model InvoiceViewToken {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  tokenHash String   @map("token_hash")
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_view_tokens")
}

model InvoiceEvent {
  id        String   @id @default(cuid())
  invoiceId String   @map("invoice_id")
  actorType ActorType @map("actor_type")
  actorId   String?  @map("actor_id")
  eventType EventType @map("event_type")
  payloadJson Json   @map("payload_json")
  createdAt DateTime @default(now()) @map("created_at")
  invoice   Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("invoice_events")
}
